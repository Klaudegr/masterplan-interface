<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masterplan Interface v1.07</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        
        #app {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        
        #map {
            flex: 1;
            position: relative;
        }
        
        #sidebar {
            width: 400px;
            background: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #header {
            padding: 20px;
            background: #2c3e50;
            color: white;
        }
        
        #header h1 { font-size: 18px; margin-bottom: 5px; }
        #header p { font-size: 12px; opacity: 0.8; }
        
        #controls {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .slider-group {
            margin-bottom: 15px;
        }
        
        .slider-group label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .slider-group input[type="range"] {
            width: 100%;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: background 0.2s;
        }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #e67e22; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-group .btn { margin-bottom: 0; }
        
        .plot-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .plot-item:hover { background: #f8f9fa; }
        
        .plot-number {
            font-weight: 600;
            font-size: 13px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .plot-details {
            font-size: 11px;
            color: #7f8c8d;
            line-height: 1.5;
        }
        
        .plot-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 11px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            flex: 1;
        }
        
        .btn-edit { background: #3498db; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        
        .info-box {
            background: #ecf0f1;
            padding: 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #555;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }
        
        .status-bar {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 13px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none;
        }
        
        .status-bar.active { display: block; }
        
        .building-3d-preview {
            background: linear-gradient(180deg, #87CEEB 0%, #E0E0E0 100%);
            padding: 20px;
            border-radius: 4px;
            margin: 15px 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            height: 200px;
            position: relative;
        }
        
        .building-3d {
            position: relative;
            transition: all 0.3s;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="map">
            <div id="status-bar" class="status-bar"></div>
        </div>
        <div id="sidebar">
            <div id="header">
                <h1>Masterplan Interface</h1>
                <p>Dubai Development Site - v1.07</p>
            </div>
            <div id="controls"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        console.log('Starting v1.07...');
        
        const INITIAL_VIEW = { lat: 25.2048, lng: 55.2708, zoom: 17 };
        
        const LAND_USES = {
            residential: { label: 'Residential', color: '#FFDC64' },
            commercial: { label: 'Commercial', color: '#FF6464' },
            mixed_use: { label: 'Mixed Use', color: '#C864FF' },
            retail: { label: 'Retail', color: '#64C8FF' },
            office: { label: 'Office', color: '#6496FF' },
            hospitality: { label: 'Hospitality', color: '#FF96C8' },
            industrial: { label: 'Industrial', color: '#969696' },
            community: { label: 'Community', color: '#64FF96' },
            open_space: { label: 'Open Space', color: '#96FF96' }
        };
        
        let map, drawnItems, drawControl;
        let plots = [];
        let formData = {
            plotNumber: '',
            districtName: '',
            landUse: 'residential',
            customColor: '#FFDC64',
            height: 30,
            plotArea: 0,
            buildingFootprintRatio: 60,
            layer: null
        };
        
        function initMap() {
            console.log('Initializing map...');
            
            map = L.map('map').setView([INITIAL_VIEW.lat, INITIAL_VIEW.lng], INITIAL_VIEW.zoom);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polygon: {
                        allowIntersection: false,
                        shapeOptions: { color: '#3498db' }
                    },
                    polyline: false,
                    rectangle: true,
                    circle: false,
                    marker: false,
                    circlemarker: false
                },
                edit: { featureGroup: drawnItems, remove: false }
            });
            
            map.addControl(drawControl);
            
            map.on(L.Draw.Event.CREATED, function(e) {
                const layer = e.layer;
                const latlngs = layer.getLatLngs()[0];
                const polygon = turf.polygon([latlngs.map(ll => [ll.lng, ll.lat])]);
                const area = turf.area(polygon);
                
                formData.plotArea = Math.round(area);
                formData.layer = layer;
                drawnItems.addLayer(layer);
                
                showBuildingForm();
            });
            
            console.log('Map initialized');
            showStartScreen();
        }
        
        function showStatus(msg) {
            const bar = document.getElementById('status-bar');
            bar.textContent = msg;
            bar.classList.add('active');
            setTimeout(() => bar.classList.remove('active'), 3000);
        }
        
        function showStartScreen() {
            document.getElementById('controls').innerHTML = `
                <div class="section">
                    <div class="section-title">Create New Plot</div>
                    <div class="info-box">
                        Click the polygon or rectangle tool on the map (top right corner) to draw plot boundaries.
                    </div>
                    <button class="btn btn-primary" onclick="startDrawing()">Start Drawing</button>
                </div>
                
                <div class="section">
                    <div class="section-title">Save & Export</div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveData()">ðŸ’¾ Save</button>
                        <button class="btn btn-warning" onclick="loadData()">ðŸ“‚ Load</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="screenshot()">ðŸ“¸ Screenshot</button>
                        <button class="btn btn-danger" onclick="exportPDF()">ðŸ“„ PDF</button>
                    </div>
                    <input type="file" id="file-input" style="display:none" accept=".json" onchange="handleFile(event)">
                </div>
                
                <div id="plot-list"></div>
            `;
            renderPlotList();
        }
        
        function startDrawing() {
            showStatus('Use polygon or rectangle tool on map (top right)');
        }
        
        function showBuildingForm() {
            document.getElementById('controls').innerHTML = `
                <div class="section">
                    <div class="section-title">Plot Details</div>
                    <div class="info-box">Plot Area: ${formData.plotArea.toLocaleString()} mÂ²</div>
                    
                    <div class="form-group">
                        <label>Plot Number</label>
                        <input type="text" id="plotNumber" placeholder="e.g., P-101">
                    </div>
                    
                    <div class="form-group">
                        <label>District Name</label>
                        <input type="text" id="districtName" placeholder="e.g., District A">
                    </div>
                    
                    <div class="form-group">
                        <label>Land Use</label>
                        <select id="landUse">
                            ${Object.entries(LAND_USES).map(([k,v]) => 
                                `<option value="${k}">${v.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Building Color</label>
                        <input type="color" id="customColor" value="${formData.customColor}" style="height:40px">
                    </div>
                    
                    <div class="slider-group">
                        <label><span>Height</span><span id="heightDisplay">30m</span></label>
                        <input type="range" id="height" min="5" max="200" value="30" oninput="updateHeight()">
                    </div>
                    
                    <div class="slider-group">
                        <label><span>Footprint</span><span id="footprintDisplay">60%</span></label>
                        <input type="range" id="footprint" min="10" max="100" value="60" oninput="updateFootprint()">
                        <div id="footprintArea" style="font-size:11px;color:#7f8c8d"></div>
                    </div>
                    
                    <div class="building-3d-preview">
                        <div class="building-3d" id="preview3d"></div>
                    </div>
                </div>
                
                <div class="section">
                    <button class="btn btn-success" onclick="savePlot()">âœ“ Save Plot</button>
                    <button class="btn btn-secondary" onclick="cancelPlot()">Cancel</button>
                </div>
            `;
            
            updateFootprint();
            updateHeight();
        }
        
        function updateHeight() {
            const val = document.getElementById('height').value;
            document.getElementById('heightDisplay').textContent = val + 'm';
            update3DPreview(val, document.getElementById('customColor').value);
        }
        
        function updateFootprint() {
            const val = document.getElementById('footprint').value;
            document.getElementById('footprintDisplay').textContent = val + '%';
            const area = Math.round(formData.plotArea * val / 100);
            document.getElementById('footprintArea').textContent = area.toLocaleString() + ' mÂ² building area';
        }
        
        function update3DPreview(height, color) {
            const preview = document.getElementById('preview3d');
            if (!preview) return;
            
            const h = Math.min(height * 0.8, 160);
            const w = 60;
            
            preview.style.width = w + 'px';
            preview.style.height = h + 'px';
            preview.style.background = color;
            preview.style.border = '2px solid rgba(0,0,0,0.2)';
            preview.style.boxShadow = '5px 5px 15px rgba(0,0,0,0.3)';
        }
        
        function savePlot() {
            const plotNumber = document.getElementById('plotNumber').value;
            const districtName = document.getElementById('districtName').value;
            
            if (!plotNumber || !districtName) {
                alert('Please enter Plot Number and District Name');
                return;
            }
            
            const plot = {
                id: Date.now(),
                plotNumber,
                districtName,
                landUse: document.getElementById('landUse').value,
                customColor: document.getElementById('customColor').value,
                height: parseInt(document.getElementById('height').value),
                plotArea: formData.plotArea,
                buildingFootprintRatio: parseInt(document.getElementById('footprint').value),
                latlngs: formData.layer.getLatLngs()[0].map(ll => [ll.lat, ll.lng])
            };
            
            plots.push(plot);
            
            formData.layer.setStyle({
                fillColor: plot.customColor,
                fillOpacity: 0.6,
                color: plot.customColor,
                weight: 3
            });
            
            const buildingArea = Math.round(plot.plotArea * plot.buildingFootprintRatio / 100);
            formData.layer.bindPopup(`
                <strong>${plot.plotNumber}</strong><br>
                District: ${plot.districtName}<br>
                Land Use: ${LAND_USES[plot.landUse].label}<br>
                Height: ${plot.height}m<br>
                Plot: ${plot.plotArea.toLocaleString()}mÂ²<br>
                Building: ${buildingArea.toLocaleString()}mÂ²
            `);
            
            plot.layer = formData.layer;
            formData.layer = null;
            
            showStartScreen();
            showStatus('Plot saved!');
        }
        
        function cancelPlot() {
            if (formData.layer) {
                drawnItems.removeLayer(formData.layer);
                formData.layer = null;
            }
            showStartScreen();
        }
        
        function deletePlot(id) {
            const plot = plots.find(p => p.id === id);
            if (!plot || !confirm(`Delete ${plot.plotNumber}?`)) return;
            
            if (plot.layer) drawnItems.removeLayer(plot.layer);
            plots = plots.filter(p => p.id !== id);
            renderPlotList();
            showStatus('Plot deleted');
        }
        
        function flyToPlot(id) {
            const plot = plots.find(p => p.id === id);
            if (!plot || !plot.layer) return;
            
            map.fitBounds(plot.layer.getBounds());
            plot.layer.openPopup();
        }
        
        function renderPlotList() {
            const container = document.getElementById('plot-list');
            if (!container) return;
            
            if (plots.length === 0) {
                container.innerHTML = `
                    <div class="section">
                        <div class="section-title">Existing Plots (0)</div>
                        <div class="empty-state"><p>No plots created yet.</p></div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="section">
                    <div class="section-title">Existing Plots (${plots.length})</div>
                    ${plots.map(p => {
                        const buildingArea = Math.round(p.plotArea * p.buildingFootprintRatio / 100);
                        return `
                            <div class="plot-item" onclick="flyToPlot(${p.id})">
                                <div class="plot-number">${p.plotNumber}</div>
                                <div class="plot-details">
                                    District: ${p.districtName}<br>
                                    Land Use: ${LAND_USES[p.landUse].label}<br>
                                    Height: ${p.height}m<br>
                                    Plot: ${p.plotArea.toLocaleString()}mÂ²<br>
                                    Building: ${buildingArea.toLocaleString()}mÂ²
                                </div>
                                <div class="plot-actions">
                                    <button class="btn-small btn-delete" onclick="event.stopPropagation(); deletePlot(${p.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function saveData() {
            const data = {
                plots: plots.map(p => ({
                    id: p.id,
                    plotNumber: p.plotNumber,
                    districtName: p.districtName,
                    landUse: p.landUse,
                    customColor: p.customColor,
                    height: p.height,
                    plotArea: p.plotArea,
                    buildingFootprintRatio: p.buildingFootprintRatio,
                    latlngs: p.latlngs
                })),
                version: '1.07'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `masterplan-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showStatus('Data saved!');
        }
        
        function loadData() {
            document.getElementById('file-input').click();
        }
        
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    plots = data.plots || [];
                    
                    drawnItems.clearLayers();
                    
                    plots.forEach(p => {
                        const layer = L.polygon(p.latlngs.map(ll => [ll[0], ll[1]]));
                        layer.setStyle({
                            fillColor: p.customColor,
                            fillOpacity: 0.6,
                            color: p.customColor,
                            weight: 3
                        });
                        
                        const buildingArea = Math.round(p.plotArea * p.buildingFootprintRatio / 100);
                        layer.bindPopup(`
                            <strong>${p.plotNumber}</strong><br>
                            District: ${p.districtName}<br>
                            Land Use: ${LAND_USES[p.landUse].label}<br>
                            Height: ${p.height}m<br>
                            Plot: ${p.plotArea.toLocaleString()}mÂ²<br>
                            Building: ${buildingArea.toLocaleString()}mÂ²
                        `);
                        
                        drawnItems.addLayer(layer);
                        p.layer = layer;
                    });
                    
                    showStartScreen();
                    showStatus('Data loaded!');
                } catch (err) {
                    alert('Error loading file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        function screenshot() {
            showStatus('Capturing...');
            html2canvas(document.getElementById('map')).then(canvas => {
                const link = document.createElement('a');
                link.download = `masterplan-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showStatus('Screenshot saved!');
            });
        }
        
        function exportPDF() {
            showStatus('Generating PDF...');
            html2canvas(document.getElementById('map')).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape', 'mm', 'a4');
                
                pdf.setFontSize(20);
                pdf.text('Masterplan Report', 15, 15);
                
                pdf.setFontSize(10);
                pdf.text(`Generated: ${new Date().toLocaleString()}`, 15, 22);
                
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 15, 30, 267, 150);
                
                pdf.setFontSize(14);
                pdf.text('Plot Summary', 15, 190);
                
                pdf.setFontSize(10);
                let y = 200;
                plots.forEach((p, i) => {
                    if (y > 280) { pdf.addPage(); y = 15; }
                    const buildingArea = Math.round(p.plotArea * p.buildingFootprintRatio / 100);
                    pdf.text(`${i+1}. ${p.plotNumber} - ${p.districtName}`, 15, y);
                    y += 5;
                    pdf.text(`   ${LAND_USES[p.landUse].label}, ${p.height}m`, 15, y);
                    y += 5;
                    pdf.text(`   Plot: ${p.plotArea.toLocaleString()}mÂ², Building: ${buildingArea.toLocaleString()}mÂ²`, 15, y);
                    y += 8;
                });
                
                pdf.save(`masterplan-${Date.now()}.pdf`);
                showStatus('PDF exported!');
            });
        }
        
        window.addEventListener('load', () => {
            console.log('Page loaded, initializing...');
            initMap();
        });
    </script>
</body>
</html>
